/**
 * ========= CONFIGURACIÓN FST NEGOCIOS =========
 */
const SHEET_NAME = "Hoja 1"; 
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzk5w7t3-nVxTathQWQWyciLeHrIbD_3OBFoJy9--93ZjMy4iLSXbQOVqfKYDXu39My/exec"; 

function doGet(e) {
  var idBusqueda = e.parameter.id;
  var datos = obtenerDatosPorId(idBusqueda);
  
  if (!datos) return HtmlService.createHtmlOutput("<h1 style='text-align:center;'>Error: Cotización no encontrada</h1>");

  // USAR createTemplateFromFile PARA QUE RECONOZCA EL CÓDIGO INTERNO
  var template = HtmlService.createTemplateFromFile('Cotizacion');
  template.data = datos;

  // EL .evaluate() ES LO QUE HACE QUE EL CÓDIGO NO SE VEA COMO TEXTO
  return template.evaluate()
      .setTitle('FST Negocios - Tarifario para ' + datos.nombre_cliente)
      .addMetaTag('viewport', 'width=device-width, initial-scale=1')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function generarLinksWeb() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  const row = sheet.getActiveCell().getRow();
  
  if (row < 2) return;

  const id = sheet.getRange(row, 1).getValue(); 
  const ahora = Utilities.formatDate(new Date(), "GMT-5", "dd/MM/yyyy HH:mm:ss");
  const link = WEB_APP_URL + "?id=" + encodeURIComponent(id);
  
  sheet.getRange(row, 24).setValue(ahora); // Columna X
  sheet.getRange(row, 26).setValue(link);  // Columna Z
  
  SpreadsheetApp.getUi().alert("✅ Cotización Generada con éxito.");
}

function obtenerDatosPorId(id) {
  const values = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME).getDataRange().getDisplayValues();
  const headers = values[0];
  for (var i = 1; i < values.length; i++) {
    if (String(values[i][0]) == String(id)) {
      var obj = {};
      headers.forEach((h, idx) => {
        var key = h.trim().toLowerCase().replace(/\s+/g, '_');
        obj[key] = values[i][idx];
      });
      return obj;
    }
  }
  return null;
}

/**
 * Se ejecuta automáticamente al editar la columna F.
 */
function onEdit(e) {
  const range = e.range;
  const sheet = range.getSheet();
  const col = range.getColumn();
  const row = range.getRow();

  // 1. Validar que estemos en "Hoja 1", Columna F (6) y no sea la cabecera
  if (sheet.getName() === "Hoja 1" && col === 6 && row > 1) {
    const servicioSeleccionado = range.getValue();
    const celdaDescripcion = sheet.getRange(row, 8); // Columna H es la 8

    if (servicioSeleccionado === "") {
      celdaDescripcion.setValue("").setBackground(null).setFontColor(null);
      return;
    }

    // 2. Buscar datos en la hoja BaseDatos
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const dbSheet = ss.getSheetByName("BaseDatos");
    const datosDb = dbSheet.getRange("A:B").getValues();
    let descripcion = "";

    for (let i = 0; i < datosDb.length; i++) {
      if (datosDb[i][0] == servicioSeleccionado) {
        descripcion = datosDb[i][1];
        break;
      }
    }

    // 3. Aplicar valor y copiar colores de la columna F a la H
    if (descripcion !== "") {
      celdaDescripcion.setValue(descripcion)
                      .setBackground(range.getBackground())
                      .setFontColor(range.getFontColor())
                      .setFontWeight(range.getFontWeight())
                      .setWrap(true);
    }
  }
}


